version: '3'
vars:
  DRIVER_VERSION: '0.9.3'
  PLUGIN_DIR: '/usr/lib/nomad/plugins'
tasks:
  default:
    cmds:
      - task: add-extras
      - task: patch-initd
      - task: patch-confd
      - task: containerd-driver
      - task: enable-nomad
  enable-nomad:
    cmds:
      - rc-update add nomad  
  add-extras:
    cmds:
      - task: addpkgs
        vars: {PKGS: "--no-cache nomad cni-plugins --repository http://dl-cdn.alpinelinux.org/alpine/edge/community"}
  patch-initd:
    cmds:
      - install -m755 -D files/nomad/nomad.initd /etc/init.d/nomad
  patch-confd:
    cmds:
      - install -m640 -o root -g root -D files/nomad/server.hcl /etc/nomad.d/server.hcl
      - install -m644 -D files/nomad/nomad.confd /etc/conf.d/nomad
  containerd-driver:
    cmds:
      - curl -sSL -o containerd-driver https://github.com/Roblox/nomad-driver-containerd/releases/download/v{{.DRIVER_VERSION}}/containerd-driver-arm64
      - install -D containerd-driver {{.PLUGIN_DIR}}/containerd-driver

  addpkgs:
    cmds:
      - apk add {{ .PKGS }}
